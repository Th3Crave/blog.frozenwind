<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="人生到处知何似，应似飞鸿踏雪泥。泥上偶然留指爪，鸿飞那复计东西。"><title>Maven | frozeNwInd</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + 'bbf19a98c9ae28f2e1e8cfcee1d9585e';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Maven</h1><a id="logo" href="/.">frozeNwInd</a><p class="description">吕乘风的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/message/"><i class="fa fa-comment"> 留言</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Maven</h1><div class="post-meta">2022-05-10<span> | </span><span class="category"><a href="/categories/technology/">technology</a><a href="/categories/technology/DevOps/">DevOps</a><a href="/categories/technology/DevOps/%E5%88%B6%E5%93%81%E7%AE%A1%E7%90%86/">制品管理</a><a href="/categories/technology/DevOps/%E5%88%B6%E5%93%81%E7%AE%A1%E7%90%86/Nexus/">Nexus</a></span></div><div class="post-content"><p>Maven是一个项目管理和整合工具。Maven为开发者提供了一套完整的构建生命周期框架。开发团队几乎不用花多少时间就能够自动完成工程的基础构建配置，因为Maven使用了一个标准的目录结构和一个默认的构建生命周期。</p>
<p>Maven的主要目的是为开发者提供：​</p>
<ul>
<li>​一个可复用、可维护、更易理解的工程综合模型，与这个模型交互的插件或工具​</li>
<li>​Maven工程结构和内容定义在一个xml文件中（一般是pom.xml）</li>
</ul>
<h2 id="Maven常用命令"><a href="#Maven常用命令" class="headerlink" title="Maven常用命令"></a>Maven常用命令</h2><h3 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h3><ul>
<li>mvn -e 显示详细错误</li>
<li>mvn -U 强制更新snapshot类型的插件或依赖库（否则maven一天只会更新一次snapshot依赖）</li>
<li>mvn -o 运行offline模式，不联网更新依赖</li>
<li>mvn -N 仅在当前项目模块执行命令，关闭reactor</li>
<li>mvn -pl module_name在指定模块上执行命令</li>
<li>mvn -ff 在递归执行命令过程中，一旦发生错误就直接退出</li>
<li>mvn -Dxxx=yyy 指定java全局属性</li>
<li>mvn -Pxxx 引用profile xxx</li>
<li>mvn -s setting.xml -gs setting.xml -Dmaven.repo.local=$(pwd)/repos package -Dmaven.test.skip=true</li>
</ul>
<h3 id="mvn-package"><a href="#mvn-package" class="headerlink" title="mvn package"></a>mvn package</h3><p>完成项目编译、单元测试、打包功能，打包到本项目，一般在项目target目录下。</p>
<p>打包文件未部署到本地Maven仓库和远程Maven仓库。</p>
<h3 id="mvn-install"><a href="#mvn-install" class="headerlink" title="mvn install"></a>mvn install</h3><p>完成项目编译、单元测试、打包功能，同时把打包文件部署到本地Maven仓库，但未部署到远程Maven仓库。</p>
<h3 id="mvn-deploy"><a href="#mvn-deploy" class="headerlink" title="mvn deploy"></a>mvn deploy</h3><p>完成项目编译、单元测试、打包功能，同时把打包文件部署到本地Maven仓库和远程Maven仓库。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mvn deploy:deploy-file </span><br><span class="line">    -Dmaven.test.skip=<span class="literal">true</span> </span><br><span class="line">    -DgroupId=com.example </span><br><span class="line">    -DartifactId=demo </span><br><span class="line">    -Dversion=1.0.0 </span><br><span class="line">    -Dpackaging=jar </span><br><span class="line">    -Dfile=demo-1.0.0.jar </span><br><span class="line">    -DrepositoryId=x-repo </span><br><span class="line">    -Durl=http://localhost:8081/nexus/content/repositories/thirdparty/ </span><br><span class="line">    -DpomFile=pom.xml</span><br></pre></td></tr></table></figure>
<ul>
<li>-DgeneratePom<br>生成pom文件，默认为true，只会生成一个最简单的pom，缺少依赖，会导致依赖该组件的服务无法获取组件的依赖。</li>
<li>-DpomFile<br>指定本地pom文件作为组件的pom。</li>
</ul>
<h4 id="调用过程"><a href="#调用过程" class="headerlink" title="调用过程"></a>调用过程</h4><p>当执行 mvn deploy 命令时，Maven 会通过<code>maven-deploy-plugin</code>将构件上传到 Nexus 的 Maven 仓库对应的 REST API。</p>
<h2 id="Maven执行原理"><a href="#Maven执行原理" class="headerlink" title="Maven执行原理"></a>Maven执行原理</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014534566/article/details/106269680?spm=1001.2014.3001.5502">https://blog.csdn.net/u014534566/article/details/106269680?spm=1001.2014.3001.5502</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yin18827152962/article/details/121482340">https://blog.csdn.net/yin18827152962/article/details/121482340</a></p>
<p>Maven本质上是定义并实现了一套管理和执行插件扩展能力的框架，从<code>mvn</code>式命令（这里的命令可以是手动输入，也可以是某些工具集成从而以程序语言执行）输入开始，mvn命令通过maven框架解析并映射到对应的maven插件库找到对应的插件包，相应的插件包接收到命令及入参执行相应行为，这是最直接的解释</p>
<h3 id="mvn命令的解析"><a href="#mvn命令的解析" class="headerlink" title="mvn命令的解析"></a>mvn命令的解析</h3><p>maven是由本质是执行命令，因为maven构建框架是固定的，变化的是插件，因此一级命令<code>mvn</code>（我们通常看到的mvn -v查看maven版本，就是这个mvn）是一致的。<br><img src="/posts/38008/mvn%E5%8E%9F%E7%90%86-mvn%E8%84%9A%E6%9C%AC.png"><br><img src="/posts/38008/mvn%E5%8E%9F%E7%90%86-mvn%E8%84%9A%E6%9C%AC-mvn%E7%9A%84%E5%89%AF%E6%9C%AC.png"></p>
<p><strong>一级命令取决于脚本的名称</strong>。毫无疑问，脚本文件的逻辑含义是maven核心之一。<br>接下来深入看看这些脚本干了啥。</p>
<h4 id="mvn"><a href="#mvn" class="headerlink" title="mvn"></a>mvn</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CLASSWORLDS_JAR=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;MAVEN_HOME&#125;</span>&quot;</span>/boot/plexus-classworlds-*.jar`</span><br><span class="line">CLASSWORLDS_LAUNCHER=org.codehaus.plexus.classworlds.launcher.Launcher</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">&quot;<span class="variable">$JAVACMD</span>&quot;</span> \</span><br><span class="line">  <span class="variable">$MAVEN_OPTS</span> \</span><br><span class="line">  <span class="variable">$MAVEN_DEBUG_OPTS</span> \</span><br><span class="line">  -classpath <span class="string">&quot;<span class="variable">$&#123;CLASSWORLDS_JAR&#125;</span>&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dclassworlds.conf=<span class="variable">$&#123;MAVEN_HOME&#125;</span>/bin/m2.conf&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dmaven.home=<span class="variable">$&#123;MAVEN_HOME&#125;</span>&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dlibrary.jansi.path=<span class="variable">$&#123;MAVEN_HOME&#125;</span>/lib/jansi-native&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dmaven.multiModuleProjectDirectory=<span class="variable">$&#123;MAVEN_PROJECTBASEDIR&#125;</span>&quot;</span> \</span><br><span class="line">  <span class="variable">$&#123;CLASSWORLDS_LAUNCHER&#125;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="mvn-cmd"><a href="#mvn-cmd" class="headerlink" title="mvn.cmd"></a>mvn.cmd</h4><p><img src="/posts/38008/mvn%E5%8E%9F%E7%90%86-mvncmd.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> %%i <span class="keyword">in</span> (<span class="string">&quot;%MAVEN_HOME%&quot;</span>\boot\plexus-classworlds-*) <span class="keyword">do</span> <span class="built_in">set</span> CLASSWORLDS_JAR=<span class="string">&quot;%%i&quot;</span></span><br><span class="line"><span class="built_in">set</span> CLASSWORLDS_LAUNCHER=org.codehaus.plexus.classworlds.launcher.Launcher</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;%JAVACMD%&quot;</span> ^</span><br><span class="line">  %JVM_CONFIG_MAVEN_PROPS% ^</span><br><span class="line">  %MAVEN_OPTS% ^</span><br><span class="line">  %MAVEN_DEBUG_OPTS% ^</span><br><span class="line">  -classpath %CLASSWORLDS_JAR% ^</span><br><span class="line">  <span class="string">&quot;-Dclassworlds.conf=%MAVEN_HOME%\bin\m2.conf&quot;</span> ^</span><br><span class="line">  <span class="string">&quot;-Dmaven.home=%MAVEN_HOME%&quot;</span> ^</span><br><span class="line">  <span class="string">&quot;-Dlibrary.jansi.path=%MAVEN_HOME%\lib\jansi-native&quot;</span> ^</span><br><span class="line">  <span class="string">&quot;-Dmaven.multiModuleProjectDirectory=%MAVEN_PROJECTBASEDIR%&quot;</span> ^</span><br><span class="line">  %CLASSWORLDS_LAUNCHER% %MAVEN_CMD_LINE_ARGS%</span><br><span class="line"><span class="keyword">if</span> ERRORLEVEL 1 goto error</span><br><span class="line">goto end</span><br></pre></td></tr></table></figure>
<p>这里干了四件事：</p>
<ol>
<li>关联配置<code>m2.conf</code>；</li>
<li>关联入口<code>plexus-classworlds-*.jar</code>及入口方法；</li>
<li>写入配置参数；</li>
<li>截取命令输入作为参数执行<code>2</code>中的方法。</li>
</ol>
<h4 id="m2-conf"><a href="#m2-conf" class="headerlink" title="m2.conf"></a>m2.conf</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main is org.apache.maven.cli.MavenCli from plexus.core</span><br><span class="line"></span><br><span class="line">set maven.conf default $&#123;maven.home&#125;/conf</span><br><span class="line"></span><br><span class="line">[plexus.core]</span><br><span class="line">load       $&#123;maven.conf&#125;/logging</span><br><span class="line">optionally $&#123;maven.home&#125;/lib/ext/*.jar</span><br><span class="line">load       $&#123;maven.home&#125;/lib/*.jar</span><br></pre></td></tr></table></figure>
<h4 id="plexus-classworlds-jar"><a href="#plexus-classworlds-jar" class="headerlink" title="plexus-classworlds-*.jar"></a>plexus-classworlds-*.jar</h4><p>plexus-classworlds-*.jar逐行解析m2.conf配置项，主要干了三件事：</p>
<ol>
<li>根据环境变量获取maven路径下lib的jar包，加载到当前的运行态中（URLClassLoader加载到URLClassPath中），包括maven-embedder-*.jar这个包，即maven执行命令<code>MavenCli</code>的入口；</li>
<li>据配置得到入口函数（MavenCli）及一些配置项，很难相信main is和from这种字符串能作为代码解析配置参数的标识；</li>
<li>结合输入命令截取的字符串作为入参，获取到的入口类通过反射调用其唯一默认的main方法，至此，maven成功进入命令解析并作出特异性插件行为阶段；</li>
</ol>
<h3 id="Maven插件路由映射"><a href="#Maven插件路由映射" class="headerlink" title="Maven插件路由映射"></a>Maven插件路由映射</h3><p>到了<code>org.apache.maven.cli.MavenCli</code>解析二级命令（即mvn之后的去前后空格字符串，如mvn deploy:deploy-file）并对应到相应的maven插件并指定该插件执行的goal，执行特定构建行为。</p>
<p>下面代码是执行mvn的核心方法，不难看出有一系列的子方法完善CliRequest类，它包含了执行插件所需要的所有参数，一条命令可能包含多条maven command line关键字，随着<code>doMain</code>方法的执行，关键字被依次解析，最终所有关键字都得以匹配，达到用户的意图。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doMain</span><span class="params">( CliRequest cliRequest )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PlexusContainer localContainer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//完善工作路径workingDirectory，若为空则默认为当前用户路径，多模块项目路径multiModuleProjectDirectory</span></span><br><span class="line">      <span class="comment">//若为空，则取maven.multiModuleProjectDirectory环境变量</span></span><br><span class="line">      initialize( cliRequest );</span><br><span class="line">      <span class="comment">//完善commandLine，解析命令，匹配程序内置的命令-v， -h</span></span><br><span class="line">      <span class="comment">//判断commandLine是否为-v或者-h，是就在控制台打印出相应的信息并退出</span></span><br><span class="line">      cli( cliRequest );</span><br><span class="line">      <span class="comment">//将系统参数和用户参数写入到请求当中systemProperties以及userProperties属性的设置</span></span><br><span class="line">      <span class="comment">//1.设置系统参数System.getenv(),一些系统级别的参数变量</span></span><br><span class="line">      <span class="comment">//2.设置运行相关参数System.getProperties()，主要是java相关的属性</span></span><br><span class="line">      <span class="comment">//3.设置maven构建的版本信息,主要从/org/apache/maven/messages/build.properties</span></span><br><span class="line">      <span class="comment">//  里获取构建信息:在maven-core的messages包下获取，就是一些版本及发布者信息等</span></span><br><span class="line">      properties( cliRequest );</span><br><span class="line">      <span class="comment">//完善执行请求中的日志属性配置，-x,-q,-e 设置MavenExecutionRequest日志级别，实际上是执行插件的日志级别</span></span><br><span class="line">      <span class="comment">//设置打印日志的消息字体颜色是否启用，其底层是用org.fusesource.jansi.Ansi来控制多色输出；</span></span><br><span class="line">      <span class="comment">//若命令中包含-b和-l部分，则控制台输出字体颜色为默认颜色</span></span><br><span class="line">      <span class="comment">//对于-l file命令，重定向日志输出到file里，通过PrintStream将System日志写入,包含setOut及setErr;</span></span><br><span class="line">      logging( cliRequest );</span><br><span class="line">      <span class="comment">//debug模式下解析解析到-V后打印版本信息</span></span><br><span class="line">      version( cliRequest );</span><br><span class="line">      <span class="comment">//构建Maven.class,负责执行maven指定的构建行为，组装了一些参数</span></span><br><span class="line">      localContainer = container( cliRequest );</span><br><span class="line">      <span class="comment">//打印一些设置信息是否开启，诸如错误日志开启，CHECKSUM_POLICY_FAIL是否开启</span></span><br><span class="line">      commands( cliRequest );</span><br><span class="line">      <span class="comment">//EventSpyDispatcher初始化及设置，-s,-gs命令解析，设置用户配置文件及全局配置文件</span></span><br><span class="line">      configure( cliRequest );</span><br><span class="line">      <span class="comment">//-t,-gt命令解析，设置toolchains</span></span><br><span class="line">      toolchains( cliRequest );</span><br><span class="line">      <span class="comment">//1.校验将会废弃的maven命令，&#123; &quot;up&quot;, &quot;npu&quot;, &quot;cpu&quot;, &quot;npr&quot; &#125;，并打印警告信息</span></span><br><span class="line">      <span class="comment">//2. 解析-b(批处理),-nsu（进展快照更新），-N（不递归到子项目中），-ff（在构建响应堆中首次失败时停止构建）</span></span><br><span class="line">      <span class="comment">//-fae(仅仅是当前失败的构建才会置为失败，其余不受影响的构建会继续)，-fn（所有的构建失败都会被忽略，无论个中构建任务失败与否）[-ff,-fae,-fn是顺序检测取第一个]</span></span><br><span class="line">      <span class="comment">//-o(设置线下操作标识)，-U（标识是否更新快照）</span></span><br><span class="line">      <span class="comment">//-C与-c（互斥出现），当checksum不匹配的时候，使用什么处理策略，默认是-c（警告）-C会使得checksum不匹配后使构建失败退出</span></span><br><span class="line">      <span class="comment">//-P xxx,xxxx（用以引入配置文件list，以逗号间隔，这里不涉及配置文件的格式及解析过程）</span></span><br><span class="line">      <span class="comment">//-ntp（在上传或者下载时不显示进度信息,这个在进度显示优先级最高）,然后如果有-l xxxx.log等日志文件，</span></span><br><span class="line">      <span class="comment">//就使用Slf4jMavenTransferListener监听并写入到日志文件，如果没有且日志级别为debug的，使用ConsoleMavenTransferListener监听进度</span></span><br><span class="line">      <span class="comment">//-f xxxx/pom.xml,加载pom.xml文件到执行参数里，如果没有设置，默认为基础路径下的pom文件,如果有父文件则进行加载和引用</span></span><br><span class="line">      <span class="comment">//-rf xxxxx（当构建失败后，重新执行从某个特定模块重新执行，选项后可跟随[groupId]:artifactId）</span></span><br><span class="line">      <span class="comment">//-pl xxxxxx（project list，以逗号间隔多个模块的相对路径，或者模块以[groupId]:artifactId的形式表示）,后面跟的每个参数项，会以+，-，!，或其他符号开始，+或其他符号为头标会被exclude，其余则被include</span></span><br><span class="line">      <span class="comment">//-am xxx，-amd xxx，xxx表示模块，设置编译行为或者编译作用域，前者表示同时编译选定模块所依赖的模块（上游make），后者表示编译依赖选定模块的部分（下游make），根据实际需求选定，若没有指定，则make时会默认把上游和下游模块都加载进来</span></span><br><span class="line">      <span class="comment">//依次在用户配置和系统配置（用户配置没有取到）里加载maven.repo.local，加载本地仓库路径到运行参数里</span></span><br><span class="line">      <span class="comment">//-T xxx（设置构建并发的并行线程数，可以在数字之后跟C，表示这个线程数需要跟当前运行时jvm可用的processor数量相乘，即针对每个内核都派发那么多线程，通过Runtime.getRuntime().availableProcessors()获取）</span></span><br><span class="line">      <span class="comment">//-b xxxxxx（指定构建器的id，默认是multithreaded构建器（builder））</span></span><br><span class="line">      populateRequest( cliRequest );</span><br><span class="line">      <span class="comment">//-emp xxx（单独的工具，对master密码进行加密并打印）,不参与构建过程</span></span><br><span class="line">      <span class="comment">//-ep xxx（单独的工具，对服务器密码进行加密并打印）,不参与构建过程</span></span><br><span class="line">      encryption( cliRequest );</span><br><span class="line">      <span class="comment">//通过两种方式判断是否使用maven2老版本的本地库而不使用远程仓库：</span></span><br><span class="line">      <span class="comment">//-llr（即legacy-local-repository,设置使用老版本参数）</span></span><br><span class="line">      <span class="comment">//系统配置maven.legacyLocalRepo为true，则使用老版本maven库</span></span><br><span class="line">      repository( cliRequest );</span><br><span class="line">      <span class="comment">//执行命令入参</span></span><br><span class="line">      <span class="keyword">return</span> execute( cliRequest );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略catch语法</span></span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( localContainer != <span class="keyword">null</span> ) &#123;</span><br><span class="line">            localContainer.dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户的执行目标及需求配置确认并封装完成之后，就开始执行构建操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.设置构建的初始化属性</span></span><br><span class="line"><span class="comment">//2.校验本地依赖库的可访问性</span></span><br><span class="line"><span class="comment">//3.创建RepositorySystemSession</span></span><br><span class="line"><span class="comment">//4.创建MavenSession</span></span><br><span class="line"><span class="comment">//5.执行AbstractLifecycleParticipant.afterSessionStart(session)</span></span><br><span class="line"><span class="comment">//6.获取校验pom对象error的对象</span></span><br><span class="line"><span class="comment">//7.创建ProjectDependencyGraph用以调整--projects和reactor模式（确保所有传递到ReactorReader的项目仅仅是指定的项目）</span></span><br><span class="line"><span class="comment">//8.创建ReactorReader用以获取对象映射（getProjectMap( projects )），在获取的时候会对对象做唯一性校验，这些对象是从第6步中获取的对象集合</span></span><br><span class="line"><span class="comment">//9.执行AbstractLifecycleParticipant.afterProjectsRead(session)后置处理</span></span><br><span class="line"><span class="comment">//10.创建ProjectDependencyGraph，不用再调整，第7步已经做了这个工作，这里要完成对AbstractLifecycleParticipants的拓扑排序，可能会改变依赖进而影响构建顺序</span></span><br><span class="line"><span class="comment">//11.开始执行LifecycleStarter.start()生命周期开始</span></span><br><span class="line"><span class="comment">//=============================================================================</span></span><br><span class="line"><span class="comment">//上述为构建执行的准备步骤，接下来是构建的详细步骤，会涉及到获取maven插件（plugin）配置的获取以及插件goal的执行，直到每个插件执行自己的构建逻辑：</span></span><br><span class="line"><span class="comment">//1.每个插件的goal执行是基于某个生命周期运行的，这里是执行插件某个gaol的入口：org.apache.maven.lifecycle.internal.LifecycleStarter#execute(MavenSession)</span></span><br><span class="line"><span class="comment">//2.执行DefaultLifecycleTaskSegmentCalculator#calculateTaskSegments，获取配置插件对应的goal集合，如果找不到就会默认用MavenSession.getTopLevelProject().getDefaultGoal(),走默认maven构建（获得的构建任务放在TaskSegment里）</span></span><br><span class="line"><span class="comment">//3.根据2中得出的构建任务，计算得出构建对象集合，封装在ProjectBuildList里，实际上是做了一个映射，当前MavenSession的所有projects都必须执行TaskSegment集合里的任务</span></span><br><span class="line"><span class="comment">//4.获取执行参数里的builderId，分为两种，单例构建或多线程构建，默认是多线程，可以通过-T命令设置线程数量，然后通过指定构建器着手进行构建工作</span></span><br><span class="line"><span class="comment">//5.构建逻辑，单例构建遍历任务集合（TaskSegment）与构建对象集合ProjectBuildList逐一进行构建，多线程按照指定的线程数量作为上限进行并发构建</span></span><br><span class="line"><span class="comment">//6.一个项目（project）构建策略，计算得出当前项目的构建计划MavenExecutionPlan，统一Project中的PluginManagement与BuildPlugin（构建模块的版本），获得MojoExecution，</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildProject</span><span class="params">( MavenSession session, MavenSession rootSession, ReactorContext reactorContext,</span></span></span><br><span class="line"><span class="params"><span class="function">                              MavenProject currentProject, TaskSegment taskSegment )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        session.setCurrentProject( currentProject );</span><br><span class="line">        <span class="keyword">long</span> buildStartTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// session may be different from rootSession seeded in DefaultMaven</span></span><br><span class="line">        <span class="comment">// explicitly seed the right session here to make sure it is used by Guice</span></span><br><span class="line">        sessionScope.enter( reactorContext.getSessionScopeMemento() );</span><br><span class="line">        sessionScope.seed( MavenSession.class, session );</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ( reactorContext.getReactorBuildStatus().isHaltedOrBlacklisted( currentProject ) ) &#123;</span><br><span class="line">                eventCatapult.fire( ExecutionEvent.Type.ProjectSkipped, session, <span class="keyword">null</span> );</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            BuilderCommon.attachToThread( currentProject );</span><br><span class="line">            projectExecutionListener.beforeProjectExecution( <span class="keyword">new</span> ProjectExecutionEvent( session, currentProject ) );</span><br><span class="line">            eventCatapult.fire( ExecutionEvent.Type.ProjectStarted, session, <span class="keyword">null</span> );</span><br><span class="line">            <span class="comment">//获取构建执行计划</span></span><br><span class="line">            MavenExecutionPlan executionPlan =</span><br><span class="line">                builderCommon.resolveBuildPlan( session, currentProject, taskSegment, <span class="keyword">new</span> HashSet&lt;Artifact&gt;() );</span><br><span class="line">            <span class="comment">//通过执行计划得到执行器</span></span><br><span class="line">            List&lt;MojoExecution&gt; mojoExecutions = executionPlan.getMojoExecutions();</span><br><span class="line">            projectExecutionListener.beforeProjectLifecycleExecution( <span class="keyword">new</span> ProjectExecutionEvent( session,</span><br><span class="line">                                                                                                 currentProject,</span><br><span class="line">                                                                                                 mojoExecutions ) );</span><br><span class="line">            <span class="comment">//执行插件构建任务，其内部是循环执行mojoExecutions对应的执行器，</span></span><br><span class="line">            <span class="comment">//具体逻辑是通过MavenPluginManager拿到插件对应的Mojo接口实例</span></span><br><span class="line">            <span class="comment">//然后执行Mojo实例，由此执行扩展接口逻辑，得到插件提供的强大扩展能力</span></span><br><span class="line">            mojoExecutor.execute( session, mojoExecutions, reactorContext.getProjectIndex() );</span><br><span class="line">            <span class="keyword">long</span> buildEndTime = System.currentTimeMillis();</span><br><span class="line">            projectExecutionListener.afterProjectExecutionSuccess( <span class="keyword">new</span> ProjectExecutionEvent( session, currentProject,</span><br><span class="line">                                                                                              mojoExecutions ) );</span><br><span class="line">            reactorContext.getResult().addBuildSummary( <span class="keyword">new</span> BuildSuccess( currentProject,</span><br><span class="line">                                                                          buildEndTime - buildStartTime ) );</span><br><span class="line">            eventCatapult.fire( ExecutionEvent.Type.ProjectSucceeded, session, <span class="keyword">null</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Throwable t ) &#123;</span><br><span class="line">            builderCommon.handleBuildError( reactorContext, rootSession, session, currentProject, t, buildStartTime );</span><br><span class="line">            projectExecutionListener.afterProjectExecutionFailure( <span class="keyword">new</span> ProjectExecutionEvent( session, currentProject, t ) );</span><br><span class="line">            <span class="comment">// rethrow original errors and runtime exceptions</span></span><br><span class="line">            <span class="keyword">if</span> ( t <span class="keyword">instanceof</span> RuntimeException ) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) t;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( t <span class="keyword">instanceof</span> Error ) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (Error) t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            sessionScope.exit();</span><br><span class="line">            session.setCurrentProject( <span class="keyword">null</span> );</span><br><span class="line">            Thread.currentThread().setContextClassLoader( reactorContext.getOriginalContextClassLoader() );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//=================执行Mojo简要说明=========================</span></span><br><span class="line">执行方法org.apache.maven.plugin.DefaultBuildPluginManager#executeMojo，调用Mojo（一个goal对应一个Mojo）能力，</span><br><span class="line">执行org.apache.maven.plugin.MavenPluginManager#getConfiguredMojo获得Mojo实例</span><br><span class="line">执行org.apache.maven.plugin.Mojo#execute执行扩展插件的实现，至此，构建脱离公共流程，</span><br><span class="line">进入插件构建运行阶段</span><br></pre></td></tr></table></figure>

<h2 id="Maven插件分析"><a href="#Maven插件分析" class="headerlink" title="Maven插件分析"></a>Maven插件分析</h2><h3 id="mvn-deploy-deploy-file-mven-deploy-plugin"><a href="#mvn-deploy-deploy-file-mven-deploy-plugin" class="headerlink" title="mvn deploy:deploy-file - mven-deploy-plugin"></a>mvn deploy:deploy-file - mven-deploy-plugin</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mojo( name = &quot;deploy-file&quot;, requiresProject = false, threadSafe = true )</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeployFileMojo</span> <span class="keyword">extends</span> <span class="title">AbstractDeployMojo</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">initProperties</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> MojoExecutionException</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> ( pomFile != <span class="keyword">null</span> ) &#123;</span><br><span class="line">          processModel( readModel( pomFile ) );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">boolean</span> foundPom = <span class="keyword">false</span>;</span><br><span class="line">          JarFile jarFile = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">try</span></span><br><span class="line">          &#123;</span><br><span class="line">              Pattern pomEntry = Pattern.compile( <span class="string">&quot;META-INF/maven/.*/pom\\.xml&quot;</span> );</span><br><span class="line">              jarFile = <span class="keyword">new</span> JarFile( file );</span><br><span class="line">              Enumeration&lt;JarEntry&gt; jarEntries = jarFile.entries();</span><br><span class="line"></span><br><span class="line">              <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> ( !foundPom ) &#123;</span><br><span class="line">                  getLog().info( <span class="string">&quot;pom.xml not found in &quot;</span> + file.getName() );</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 核心逻辑执行方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> MojoExecutionException, MojoFailureException </span>&#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对pom文件的处理</span></span><br><span class="line">    initProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deploymentRepository</span></span><br><span class="line">    ArtifactRepository deploymentRepository = createDeploymentArtifactRepository( repositoryId, url );</span><br><span class="line">    <span class="comment">// deployableArtifacts</span></span><br><span class="line">    List&lt;Artifact&gt; deployableArtifacts = <span class="keyword">new</span> ArrayList&lt;Artifact&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// deploy</span></span><br><span class="line">        artifactDeployer.deploy( getSession().getProjectBuildingRequest(), deploymentRepository, deployableArtifacts );</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( ArtifactDeployerException e ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MojoExecutionException( e.getMessage(), e );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tags"><a href="/tags/Maven"><i class="fa fa-tag">Maven</i></a></div><div class="post-nav"><a class="pre" href="/posts/39767.html">Java Map - HashMap源码分析</a><a class="next" href="/posts/13516.html">Nexus-升级https过程</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '8359b7a19b78f2b9e112',
  clientSecret: '5ad69dc1633a1834322067d017b6313bd231457c',
  repo: 'gitalk',
  owner: 'Th3Crave',
  admin: ['Th3Crave'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Maven%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">Maven常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-text">常用参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mvn-package"><span class="toc-text">mvn package</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mvn-install"><span class="toc-text">mvn install</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mvn-deploy"><span class="toc-text">mvn deploy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-text">调用过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maven%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-text">Maven执行原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mvn%E5%91%BD%E4%BB%A4%E7%9A%84%E8%A7%A3%E6%9E%90"><span class="toc-text">mvn命令的解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mvn"><span class="toc-text">mvn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mvn-cmd"><span class="toc-text">mvn.cmd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#m2-conf"><span class="toc-text">m2.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#plexus-classworlds-jar"><span class="toc-text">plexus-classworlds-*.jar</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Maven%E6%8F%92%E4%BB%B6%E8%B7%AF%E7%94%B1%E6%98%A0%E5%B0%84"><span class="toc-text">Maven插件路由映射</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maven%E6%8F%92%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-text">Maven插件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mvn-deploy-deploy-file-mven-deploy-plugin"><span class="toc-text">mvn deploy:deploy-file - mven-deploy-plugin</span></a></li></ol></li></ol></div><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">frozeNwInd.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>