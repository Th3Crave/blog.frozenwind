<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="人生到处知何似，应似飞鸿踏雪泥。泥上偶然留指爪，鸿飞那复计东西。"><title>分布式任务 | frozeNwInd</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + 'bbf19a98c9ae28f2e1e8cfcee1d9585e';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分布式任务</h1><a id="logo" href="/.">frozeNwInd</a><p class="description">吕乘风的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/message/"><i class="fa fa-comment"> 留言</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">分布式任务</h1><div class="post-meta">2023-05-25<span> | </span><span class="category"><a href="/categories/technology/">technology</a><a href="/categories/technology/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></span></div><div class="post-content"><p>分布式定时任务调度。</p>
<h2 id="xxl-job"><a href="#xxl-job" class="headerlink" title="xxl-job"></a>xxl-job</h2><p><a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<h2 id="基于xxl-job二次开发"><a href="#基于xxl-job二次开发" class="headerlink" title="基于xxl-job二次开发"></a>基于xxl-job二次开发</h2><p><img src="/2023/05/25/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1/ischeduler%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png"></p>
<ul>
<li>i-scheduler-spring-boot-starter<br>  其它web服务只需引用此starter包即可。<br>  依赖i-scheduler-core。</li>
<li>i-scheduler-core<br>  starter组件核心模块，提供其它服务需要实现的BaseSchedule，HandlerPoolHelper通过反射的方式调用具体的Schedule任务。</li>
<li>i-scheduler-admin<br>  分布式任务调度中心。</li>
<li>i-scheduler-web<br>  管理页面。</li>
</ul>
<h3 id="i-scheduler-spring-boot-starter"><a href="#i-scheduler-spring-boot-starter" class="headerlink" title="i-scheduler-spring-boot-starter"></a>i-scheduler-spring-boot-starter</h3><h4 id="ScheduleAutoConfiguration"><a href="#ScheduleAutoConfiguration" class="headerlink" title="ScheduleAutoConfiguration"></a>ScheduleAutoConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// springboot自动装配</span></span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.haier.schedule.starter.ScheduleAutoConfiguration</span><br></pre></td></tr></table></figure>
<ol>
<li>声明i-scheduler组件所需的Bean</li>
<li>添加SchedulerInterceptor拦截器，以便任务调度</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleAutoConfiguration</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;server.port:8080&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> String port;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String adminAddress = <span class="string">&quot;http://scheduler-admin.i-scheduler:8080/api&quot;</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;server.servlet.context-path:&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> String contextPath;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;scheduler.admin.open:true&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> Boolean open;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Value(&quot;$&#123;scheduler.job.open:true&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> Boolean jobOpen;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Lazy</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> SchedulerInterceptor schedulerInterceptor;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.open != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.open.booleanValue())</span><br><span class="line">    <span class="keyword">return</span>; </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jobOpen != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.jobOpen.booleanValue())</span><br><span class="line">    <span class="keyword">return</span>; </span><br><span class="line">    registry.addInterceptor(<span class="keyword">this</span>.schedulerInterceptor)</span><br><span class="line"></span><br><span class="line">    .addPathPatterns(<span class="keyword">new</span> String[] &#123; <span class="string">&quot;/**&quot;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 拦截器</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SchedulerInterceptor <span class="title">schedulerInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SchedulerInterceptor();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ReportPoolHelper <span class="title">reportPoolHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReportPoolHelper(<span class="keyword">this</span>.adminAddress);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> HandlerPoolHelper <span class="title">handlerPoolHelper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HandlerPoolHelper();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 业务服务定时任务执行器</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ScheduleExecutor <span class="title">executor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ScheduleExecutor(<span class="keyword">this</span>.port, <span class="keyword">this</span>.adminAddress, <span class="keyword">this</span>.contextPath, <span class="keyword">this</span>.open, <span class="keyword">this</span>.jobOpen);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 切面</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ScheduleAspect <span class="title">aspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ScheduleAspect(<span class="keyword">this</span>.adminAddress);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 运行器</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SchedulerRunner <span class="title">runner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SchedulerRunner(<span class="keyword">this</span>.adminAddress, <span class="keyword">this</span>.contextPath, <span class="keyword">this</span>.port, <span class="keyword">this</span>.open);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SchedulerInterceptor"><a href="#SchedulerInterceptor" class="headerlink" title="SchedulerInterceptor"></a>SchedulerInterceptor</h4><p>拦截器，处理i-scheduler-admin传递的调度请求，以反射的方式调用实际需要执行的任务方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HandlerPoolHelper handlerPoolHelper;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String servletPath = request.getServletPath();</span><br><span class="line">        <span class="keyword">if</span> (!servletPath.startsWith(<span class="string">&quot;/i_scheduler&quot;</span>))</span><br><span class="line">            <span class="comment">// 非调度请求，执行其它的拦截器</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>; </span><br><span class="line">        String path = servletPath.replaceAll(<span class="string">&quot;/i_scheduler/&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;ping&quot;</span>.equals(path)) &#123;</span><br><span class="line">            response.setStatus(<span class="number">200</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;stop&quot;</span>)) &#123;</span><br><span class="line">            Long id;</span><br><span class="line">            String idStr = path.substring(path.indexOf(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                id = Long.valueOf(Long.parseLong(idStr));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            SchedulerContext schedulerContext = ScheduleAspect.getSchedulerContext(id);</span><br><span class="line">            <span class="keyword">if</span> (schedulerContext != <span class="keyword">null</span>)</span><br><span class="line">                schedulerContext.setStop(<span class="keyword">true</span>); </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射 获取BaseSchedule</span></span><br><span class="line">        MethodHandler methodHandler = ScheduleExecutor.getMethod(path);</span><br><span class="line">        <span class="keyword">if</span> (methodHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.setStatus(<span class="number">404</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">byte</span>[] bodyBytes = StreamUtils.copyToByteArray((InputStream)request.getInputStream());</span><br><span class="line">        String body = <span class="keyword">new</span> String(bodyBytes, request.getCharacterEncoding());</span><br><span class="line">        Parameter parameter = (Parameter)JacksonUtil.readValue(body, Parameter.class);</span><br><span class="line">        <span class="comment">// 调度任务线程池执行任务</span></span><br><span class="line">        <span class="keyword">this</span>.handlerPoolHelper.addBiz(methodHandler, <span class="keyword">new</span> Object[] &#123; parameter &#125;);</span><br><span class="line">        response.setStatus(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 停止拦截器的链式调用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ScheduleExecutor"><a href="#ScheduleExecutor" class="headerlink" title="ScheduleExecutor"></a>ScheduleExecutor</h4><ol>
<li>ApplicationContextAware<br> 应用程序上下文感知接口。通过实现该接口,我们可以获取ApplicationContext对象,进而获取BeanDefinitionRegistry等底层结构。<br> 通过重写 void setApplicationContext(ApplicationContext context) 方法,我们可以在Bean初始化之后立即获取ApplicationContext。</li>
<li>SmartInitializingSingleton<br> Spring的一个感知接口,用于在Spring容器完成所有的初始化Bean之后,执行一段代码。<br> 通过实现SmartInitializingSingleton接口并重写afterSingletonsInstantiated()方法,我们可以在容器初始化完成后立即执行一段逻辑。</li>
<li>DisposableBean<br> 在Bean生命周期结束前调用destory()方法做一些收尾工作</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleExecutor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">SmartInitializingSingleton</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(ScheduleExecutor.class);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, MethodHandler&gt; schedulerMethods = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String port;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String adminAddress;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String contextPath;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> Boolean open;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> Boolean jobOpen;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> ReportPoolHelper reportPoolHelper;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> HandlerPoolHelper handlerPoolHelper;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ScheduleExecutor</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ScheduleExecutor</span><span class="params">(String port, String adminAddress, String contextPath, Boolean open, Boolean jobOpen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.port = port;</span><br><span class="line">    <span class="keyword">this</span>.adminAddress = adminAddress;</span><br><span class="line">    <span class="keyword">this</span>.contextPath = contextPath;</span><br><span class="line">    <span class="keyword">this</span>.open = open;</span><br><span class="line">    <span class="keyword">this</span>.jobOpen = jobOpen;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 结束执行器</span></span><br><span class="line">    <span class="keyword">this</span>.handlerPoolHelper.stop();</span><br><span class="line">    <span class="comment">// 结束上报器</span></span><br><span class="line">    <span class="keyword">this</span>.reportPoolHelper.stop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在容器初始化完成后立即执行一段逻辑</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.open != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.open.booleanValue())</span><br><span class="line">      <span class="keyword">return</span>; </span><br><span class="line">    Map&lt;String, BaseSchedule&gt; schedulerBeans = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.jobOpen == <span class="keyword">null</span> || <span class="keyword">this</span>.jobOpen.booleanValue())</span><br><span class="line">      schedulerBeans = applicationContext.getBeansOfType(BaseSchedule.class); </span><br><span class="line">    RegisterParam register = <span class="keyword">new</span> RegisterParam();</span><br><span class="line">    register.setPort(<span class="keyword">this</span>.port);</span><br><span class="line">    register.setAppName(System.getenv(<span class="string">&quot;APP_NAME&quot;</span>));</span><br><span class="line">    register.setClusterName(System.getenv(<span class="string">&quot;CLUSTER_NAME&quot;</span>));</span><br><span class="line">    register.setProject(System.getenv(<span class="string">&quot;TENANT_NAME&quot;</span>));</span><br><span class="line">    register.setNamespace(System.getenv(<span class="string">&quot;POD_NAMESPACE&quot;</span>));</span><br><span class="line">    register.setContextPath(<span class="keyword">this</span>.contextPath);</span><br><span class="line">    register.setSchedulerList(<span class="keyword">new</span> ArrayList());</span><br><span class="line">    <span class="keyword">if</span> (schedulerBeans != <span class="keyword">null</span> &amp;&amp; !schedulerBeans.isEmpty())</span><br><span class="line">      <span class="keyword">for</span> (BaseSchedule scheduler : schedulerBeans.values()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Method doWork = scheduler.getClass().getDeclaredMethod(<span class="string">&quot;doWork&quot;</span>, <span class="keyword">new</span> Class[] &#123; Parameter.class &#125;);</span><br><span class="line">          <span class="keyword">if</span> (doWork == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">          String name = <span class="keyword">null</span>;</span><br><span class="line">          String cron = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">boolean</span> cover = <span class="keyword">false</span>;</span><br><span class="line">          Scheduler annotation = (Scheduler)AnnotationUtils.findAnnotation(doWork, Scheduler.class);</span><br><span class="line">          <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            name = annotation.value();</span><br><span class="line">            cron = annotation.cron();</span><br><span class="line">            cover = annotation.cover();</span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            name = ClassUtils.getUserClass(scheduler.getClass()).getSimpleName();</span><br><span class="line">            name = decapitalize(name);</span><br><span class="line">          &#125; </span><br><span class="line">          <span class="keyword">if</span> (schedulerMethods.containsKey(name))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;存在重名任务，请修改&quot;</span>); </span><br><span class="line">          register.getSchedulerList().add(<span class="keyword">new</span> SchedulerConf(name, cron, Boolean.valueOf(cover)));</span><br><span class="line">          schedulerMethods.put(name, <span class="keyword">new</span> MethodHandler(scheduler, doWork));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125; </span><br><span class="line">      &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 向i-scheduler-admin注册任务信息</span></span><br><span class="line">    HttpUtil.post(<span class="keyword">this</span>.adminAddress + <span class="string">&quot;/register&quot;</span>, register);</span><br><span class="line">    log.info(<span class="string">&quot;定时任务信息注册完成&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.reportPoolHelper.start();</span><br><span class="line">    <span class="keyword">this</span>.handlerPoolHelper.start();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>;</span><br><span class="line">    ScheduleExecutor.applicationContext = applicationContext;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> applicationContext;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MethodHandler <span class="title">getMethod</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> schedulerMethods.get(key);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">decapitalize</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> name; </span><br><span class="line">    <span class="keyword">if</span> (name.length() &gt; <span class="number">1</span> &amp;&amp; Character.isUpperCase(name.charAt(<span class="number">1</span>)) &amp;&amp; </span><br><span class="line">      Character.isUpperCase(name.charAt(<span class="number">0</span>)))</span><br><span class="line">      <span class="keyword">return</span> name; </span><br><span class="line">    <span class="keyword">char</span>[] chars = name.toCharArray();</span><br><span class="line">    chars[<span class="number">0</span>] = Character.toLowerCase(chars[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(chars);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SchedulerRunner"><a href="#SchedulerRunner" class="headerlink" title="SchedulerRunner"></a>SchedulerRunner</h4><ul>
<li>ApplicationRunner<br>  应用程序运行器接口。通过实现该接口,我们可以在应用启动后立即运行一段代码。<br>  需要重写 void run(ApplicationArguments args)方法,该方法会在SpringApplication启动后直接调用。</li>
</ul>
<p>SpringBootApplication启动成功，向i-scheduler-admin调度中心注册应用程序执行器信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerRunner</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(SchedulerRunner.class);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String adminUrl;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String contextPath;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String port;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> Boolean open;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SchedulerRunner</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SchedulerRunner</span><span class="params">(String adminUrl, String contextPath, String port, Boolean open)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.adminUrl = adminUrl;</span><br><span class="line">    <span class="keyword">this</span>.contextPath = contextPath;</span><br><span class="line">    <span class="keyword">this</span>.port = port;</span><br><span class="line">    <span class="keyword">this</span>.open = open;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.open != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.open.booleanValue())</span><br><span class="line">      <span class="keyword">return</span>; </span><br><span class="line">    RegisterParam register = <span class="keyword">new</span> RegisterParam();</span><br><span class="line">    register.setPort(<span class="keyword">this</span>.port);</span><br><span class="line">    register.setContextPath(<span class="keyword">this</span>.contextPath);</span><br><span class="line">    register.setAppName(System.getenv(<span class="string">&quot;APP_NAME&quot;</span>));</span><br><span class="line">    register.setClusterName(System.getenv(<span class="string">&quot;CLUSTER_NAME&quot;</span>));</span><br><span class="line">    register.setAddress(String.format(<span class="string">&quot;http://%s:%s&quot;</span>, <span class="keyword">new</span> Object[] &#123; System.getenv(<span class="string">&quot;POD_IP&quot;</span>), <span class="keyword">this</span>.port &#125;));</span><br><span class="line">    register.setProject(System.getenv(<span class="string">&quot;TENANT_NAME&quot;</span>));</span><br><span class="line">    register.setNamespace(System.getenv(<span class="string">&quot;POD_NAMESPACE&quot;</span>));</span><br><span class="line">    register.setPodName(System.getenv(<span class="string">&quot;POD_NAME&quot;</span>));</span><br><span class="line">    HttpUtil.post(<span class="keyword">this</span>.adminUrl + <span class="string">&quot;/exec/register&quot;</span>, register);</span><br><span class="line">    log.info(<span class="string">&quot;执行器信息注册完成&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id><a href="#" class="headerlink" title></a></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleAspect</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String adminAddress;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Long, SchedulerContext&gt; schedulerContextMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ScheduleAspect</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ScheduleAspect</span><span class="params">(String adminAddress)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.adminAddress = adminAddress;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SchedulerContext <span class="title">getSchedulerContext</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="keyword">null</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">    <span class="keyword">return</span> schedulerContextMap.get(id);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// @Scheduler注解切面</span></span><br><span class="line">  <span class="meta">@Around(&quot;@annotation(com.haier.schedule.core.annotation.Scheduler)&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint point)</span> </span>&#123;</span><br><span class="line">    Long execId = <span class="keyword">null</span>;</span><br><span class="line">    CallbackParam callbackParam = <span class="keyword">new</span> CallbackParam();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Object arg = point.getArgs()[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> (!(arg <span class="keyword">instanceof</span> Parameter)) &#123;</span><br><span class="line">        point.proceed();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; </span><br><span class="line">      Parameter param = (Parameter)arg;</span><br><span class="line">      callbackParam.setId(param.getId());</span><br><span class="line">      callbackParam.setTriggerId(param.getTriggerId());</span><br><span class="line">      callbackParam.setJobId(param.getJobId());</span><br><span class="line">      SchedulerContext schedulerContext = <span class="keyword">new</span> SchedulerContext(param.getId().longValue(), param.getShardIndex().intValue(), param.getShardTotal().intValue());</span><br><span class="line">      SchedulerContext.setScheduleContext(schedulerContext);</span><br><span class="line">      execId = param.getId();</span><br><span class="line">      schedulerContextMap.put(execId, schedulerContext);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 执行过程</span></span><br><span class="line">      point.proceed();</span><br><span class="line"></span><br><span class="line">      callbackParam.setStatus(Integer.valueOf(<span class="number">200</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      callbackParam.setStatus(Integer.valueOf(<span class="number">500</span>));</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (execId != <span class="keyword">null</span>)</span><br><span class="line">        schedulerContextMap.remove(execId); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// callback 回传本次任务执行情况</span></span><br><span class="line">    HttpUtil.post(<span class="keyword">this</span>.adminAddress + <span class="string">&quot;/callback&quot;</span>, callbackParam);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="i-scheduler-admin"><a href="#i-scheduler-admin" class="headerlink" title="i-scheduler-admin"></a>i-scheduler-admin</h3><h3 id="i-scheduler-core"><a href="#i-scheduler-core" class="headerlink" title="i-scheduler-core"></a>i-scheduler-core</h3></div><div class="tags"><a href="/tags/分布式"><i class="fa fa-tag">分布式</i></a></div><div class="post-nav"><a class="pre" href="/2023/05/26/Spring-%E5%89%8D%E8%A8%80/">Spring-前言</a><a class="next" href="/2023/05/25/Spring-AOP-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/">Spring-AOP-实现原理详解</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '8359b7a19b78f2b9e112',
  clientSecret: '5ad69dc1633a1834322067d017b6313bd231457c',
  repo: 'gitalk',
  owner: 'Th3Crave',
  admin: ['Th3Crave'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#xxl-job"><span class="toc-text">xxl-job</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Exxl-job%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91"><span class="toc-text">基于xxl-job二次开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#i-scheduler-spring-boot-starter"><span class="toc-text">i-scheduler-spring-boot-starter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ScheduleAutoConfiguration"><span class="toc-text">ScheduleAutoConfiguration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SchedulerInterceptor"><span class="toc-text">SchedulerInterceptor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ScheduleExecutor"><span class="toc-text">ScheduleExecutor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SchedulerRunner"><span class="toc-text">SchedulerRunner</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#i-scheduler-admin"><span class="toc-text">i-scheduler-admin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#i-scheduler-core"><span class="toc-text">i-scheduler-core</span></a></li></ol></li></ol></div><script type="text/javascript" src="/js/toc.js?v=1.0.0"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">frozeNwInd.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>